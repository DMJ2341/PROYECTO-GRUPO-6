# backend/Dockerfile
FROM python:3.11-slim

# Variables de entorno
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PORT=8000

# Crear usuario no-root
RUN useradd -m -u 1000 appuser && \
    mkdir -p /app/data && \
    chown -R appuser:appuser /app

WORKDIR /app

# Copiar requirements PRIMERO (para cache de Docker)
COPY --chown=appuser:appuser requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copiar c√≥digo
COPY --chown=appuser:appuser . .

# Cambiar permisos de data
RUN chown -R appuser:appuser /app/data

# Usuario no-root
USER appuser

# Health check corregido - puerto 8000 y ruta correcta
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD python -c "import requests; requests.get('http://localhost:8000/health').raise_for_status()"

# Arrancar
CMD ["python", "app.py"]